#!/usr/bin/env bash
set -euo pipefail

db="/etc/pihole/gravity.db"

# Decode group name from systemd unit name
# Replaces double underscores with spaces
decode_group() {
  local encoded="$1"
  echo "${encoded//__/ }"
}

arg="${1:-}"
case "$arg" in
  enable:*)  val=1; encoded_group="${arg#enable:}" ;;
  disable:*) val=0; encoded_group="${arg#disable:}" ;;
  *) echo "Usage: enable:<group> | disable:<group>" >&2; exit 2 ;;
esac

# Decode the group name (convert __ back to spaces)
group="$(decode_group "$encoded_group")"

# Escape single quotes for SQLite string literals
group_sql=${group//\'/\'\'}

# Make sure group exists (otherwise fail loudly)
exists="$(pihole-FTL sqlite3 "$db" "SELECT COUNT(1) FROM \"group\" WHERE name='$group_sql';")"
if [[ "$exists" != "1" ]]; then
  echo "Group not found in DB: $group" >&2
  exit 3
fi

# Update enabled flag
pihole-FTL sqlite3 "$db" "UPDATE \"group\" SET enabled=$val WHERE name='$group_sql';"

# Apply changes
if command -v pihole >/dev/null 2>&1; then
  pihole reloaddns
  pihole reloadlists
fi